<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tradex App</title>
<style>
  /* ваш стиль без изменений */
  body, html {
    margin: 0; padding: 0; height: 100%; background-color: #0e0e10; font-family: sans-serif; color: white;
  }
  #login-container {
    height: 100vh; width: 100vw;
    display: flex; align-items: center; justify-content: center;
    background-color: #0e0e10; flex-direction: column;
  }
  #login-container h1 {
    margin-bottom: 20px;
    font-weight: 700;
    font-size: 28px;
    letter-spacing: 1.5px;
  }
  #login-container input {
    margin: 8px 0;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #555;
    background-color: #1a1a1a;
    color: white;
    width: 200px;
    font-size: 16px;
  }
  #login-container button {
    padding: 10px 20px;
    background-color: #3a3a3a;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 16px;
    margin-top: 10px;
  }
  #login-error {
    color: #f44336;
    margin-top: 10px;
    height: 20px;
  }
  #loader {
    height: 100vh; width: 100vw;
    display: none;
    align-items: center; justify-content: center;
    background-color: #0e0e10;
    flex-direction: column;
    font-size: 20px;
    letter-spacing: 2px;
  }
  .abstergo-loader {
    display: flex;
    gap: 10px;
  }
  .abstergo-loader div {
    width: 15px; height: 15px;
    background: #00ff99;
    border-radius: 50%;
    animation: pulse 1.5s infinite ease-in-out;
  }
  .abstergo-loader div:nth-child(2) {
    animation-delay: 0.3s;
  }
  .abstergo-loader div:nth-child(3) {
    animation-delay: 0.6s;
  }
  @keyframes pulse {
    0%, 100% { opacity: 0.2; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.5); }
  }
  #app {
    display: none;
    height: 100vh; width: 100vw;
    background-color: #0e0e10;
    position: relative;
    overflow: hidden;
  }
  #symbol-selector {
    position: absolute;
    top: 15px; left: 15px;
    background: rgba(20,20,20,0.85);
    border: 1px solid #444;
    border-radius: 6px;
    padding: 12px;
    z-index: 10;
  }
  #symbol-selector label, select {
    color: white;
    font-weight: 600;
    font-size: 14px;
  }
  select {
    margin-left: 8px;
    background: #0e0e10;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 4px 8px;
    color: white;
  }
  #chart-canvas {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100%; height: 100%;
  }
  #bot {
    position: absolute;
    top: 50px;
    left: 20px;
    background: rgba(0,0,0,0.8);
    border-radius: 8px;
    padding: 15px;
    width: 260px;
    font-size: 14px;
    color: #00ff99;
    box-shadow: 0 0 12px #00ff99aa;
    user-select: none;
  }
  #bot h2 {
    margin: 0 0 12px 0;
    font-weight: 700;
    font-size: 18px;
    color: #00ffaa;
  }
  #bot ul {
    list-style: none;
    padding: 0; margin: 0;
  }
  #bot ul li {
    margin-bottom: 10px;
    line-height: 1.3;
  }
</style>
</head>
<body>

<div id="login-container">
  <h1>Войти в Tradex</h1>
  <input type="text" id="login" placeholder="Login" autocomplete="off" />
  <input type="password" id="password" placeholder="Password" autocomplete="off" />
  <button id="login-btn">Sign In</button>
  <div id="login-error"></div>
</div>

<div id="loader">
  <div class="abstergo-loader">
    <div></div><div></div><div></div>
  </div>
  <div style="margin-top:15px;">Tradex App Loading</div>
</div>

<div id="app">
  <div id="symbol-selector">
    <label for="symbol">Монета:</label>
    <select id="symbol">
      <option value="bitcoin">Bitcoin (BTC)</option>
      <option value="ethereum">Ethereum (ETH)</option>
      <option value="solana">Solana (SOL)</option>
      <option value="ripple">XRP</option>
      <option value="dogecoin">Dogecoin (DOGE)</option>
      <option value="cardano">Cardano (ADA)</option>
    </select>
  </div>
  <canvas id="chart-canvas"></canvas>
  <div id="bot">
    <h2>Прогнозы бота</h2>
    <ul id="bot-messages">
      <!-- Здесь будут прогнозы -->
    </ul>
  </div>
</div>

<script>
const loginContainer = document.getElementById('login-container');
const loader = document.getElementById('loader');
const app = document.getElementById('app');
const loginBtn = document.getElementById('login-btn');
const loginError = document.getElementById('login-error');
const symbolSelect = document.getElementById('symbol');
const canvas = document.getElementById('chart-canvas');
const ctx = canvas.getContext('2d');
const botMessagesUl = document.getElementById('bot-messages');

const validLogin = 'admin';
const validPassword = 'MODERATOR';

let dataPoints = [];
let animationId = null;
let currentSymbol = symbolSelect.value;
let lastTimestamp = 0;

const botForecasts = {
  bitcoin: [
    'BTC растет, возможен откат.',
    'Покупка по текущей цене — рискованно.',
    'Ожидается сильное движение вверх.',
    'Цена может зафиксировать уровень поддержки.',
  ],
  ethereum: [
    'ETH стабилизируется, можно ждать входа.',
    'Высокая волатильность сегодня.',
    'Ожидается рост на новостях.',
    'Возможен небольшой спад перед ростом.',
  ],
  solana: [
    'SOL демонстрирует силу, держать позиции.',
    'Скоро может быть коррекция.',
    'Идеальное время для покупки.',
    'Прогноз — боковой тренд.',
  ],
  ripple: [
    'XRP может пробить сопротивление.',
    'Будьте осторожны, возможен флэт.',
    'Позитивный настрой рынка.',
    'Краткосрочная фиксация прибыли возможна.',
  ],
  dogecoin: [
    'DOGE нестабилен, играть осторожно.',
    'Ожидается всплеск активности.',
    'Можно рассматривать для краткосрочных сделок.',
    'Риск высок, рекомендуем наблюдать.',
  ],
  cardano: [
    'ADA укрепляет позиции.',
    'Небольшая коррекция — нормальное явление.',
    'Рост на фоне позитивных новостей.',
    'Текущий уровень — хороший вход.',
  ],
};

// Автоматический вход по Enter
document.getElementById('login').addEventListener('keydown', e => {
  if (e.key === 'Enter') loginBtn.click();
});
document.getElementById('password').addEventListener('keydown', e => {
  if (e.key === 'Enter') loginBtn.click();
});

// Вход
loginBtn.addEventListener('click', () => {
  const login = document.getElementById('login').value.trim();
  const password = document.getElementById('password').value.trim();
  if (login === validLogin && password === validPassword) {
    loginError.textContent = '';
    loginContainer.style.display = 'none';
    loader.style.display = 'flex';
    setTimeout(() => {
      loader.style.display = 'none';
      app.style.display = 'block';
      initCanvas();
      loadHistoricalData(currentSymbol).then(() => {
        startBot();
        startChartAnimation();
      });
    }, 3000); // 3 сек лоадера
  } else {
    loginError.textContent = 'Неверный логин или пароль';
  }
});

// Инициализация canvas
function initCanvas() {
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
}

// resize
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

// Загрузка исторических данных с CoinGecko (1 день, 200 точек)
async function loadHistoricalData(symbol) {
  dataPoints = [];
  try {
    const url = `https://api.coingecko.com/api/v3/coins/${symbol}/market_chart?vs_currency=usd&days=1&interval=hourly`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Ошибка загрузки данных');
    const json = await res.json();
    // json.prices - массив [timestamp, price]
    // берем максимум 200 точек, если меньше - берем все
    let prices = json.prices;
    if (prices.length > 200) {
      // выборочно возьмём равномерно
      const step = Math.floor(prices.length / 200);
      prices = prices.filter((_, i) => i % step === 0).slice(0, 200);
    }
    dataPoints = prices.map(p => p[1]);
  } catch (e) {
    console.error(e);
    // fallback: если ошибка, создадим пустой массив с 200 элементами текущей цены 0
    dataPoints = new Array(200).fill(0);
  }
  drawChart();
}

// Обновление данных: запрашиваем текущую цену и добавляем в dataPoints
async function updateData() {
  try {
    const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${currentSymbol}&vs_currencies=usd`);
    if (!res.ok) throw new Error('Ошибка загрузки текущей цены');
    const json = await res.json();
    const price = json[currentSymbol]?.usd;
    if (price !== undefined && price !== null) {
      dataPoints.shift();
      dataPoints.push(price);
    }
  } catch (e) {
    console.error(e);
    // При ошибке можно не добавлять новую точку или добавить последнюю цену без изменений
    const last = dataPoints.length ? dataPoints[dataPoints.length - 1] : 0;
    dataPoints.shift();
    dataPoints.push(last);
  }
}

// Рисуем график — то же что и было
function drawChart() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#0e0e10';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  if (!dataPoints.length) return;

  const maxPrice = Math.max(...dataPoints);
  const minPrice = Math.min(...dataPoints);
  const margin = 50;
  const height = canvas.height - 2 * margin;
  const width = canvas.width - 2 * margin;

  ctx.strokeStyle = '#444';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(margin, margin);
  ctx.lineTo(margin, canvas.height - margin);
  ctx.lineTo(canvas.width - margin, canvas.height - margin);
  ctx.stroke();

  ctx.strokeStyle = '#00ff99';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (let i = 0; i < dataPoints.length; i++) {
    const x = margin + (i / dataPoints.length) * width;
    const y = margin + height * (1 - (dataPoints[i] - minPrice) / (maxPrice - minPrice || 1));
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();

  ctx.fillStyle = '#00ff99';
  for (let i = 0; i < dataPoints.length; i += 10) {
    const x = margin + (i / dataPoints.length) * width;
    const y = margin + height * (1 - (dataPoints[i] - minPrice) / (maxPrice - minPrice || 1));
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI * 2);
    ctx.fill();
  }

  ctx.fillStyle = '#00ff99';
  ctx.font = '14px monospace';
  ctx.fillText(currentSymbol.toUpperCase(), margin, margin - 10);
  ctx.fillText(maxPrice.toFixed(2), 5, margin + 5);
  ctx.fillText(minPrice.toFixed(2), 5, canvas.height - margin);
}

let botInterval = null;
let updateIntervalId = null;

// Анимация
function startChartAnimation() {
  if(updateIntervalId) clearInterval(updateIntervalId);
  updateIntervalId = setInterval(async () => {
    await updateData();
    drawChart();
  }, 5000); // обновление каждые 5 секунд
}

function stopChartAnimation() {
  if(updateIntervalId) {
    clearInterval(updateIntervalId);
    updateIntervalId = null;
  }
}

// При смене монеты
symbolSelect.addEventListener('change', async e => {
  currentSymbol = e.target.value;
  stopChartAnimation();
  await loadHistoricalData(currentSymbol);
  drawChart();
  startChartAnimation();
  updateBotMessages();
});

// Бот — обновляет прогнозы каждые 5 сек
function startBot() {
  updateBotMessages();
  if(botInterval) clearInterval(botInterval);
  botInterval = setInterval(updateBotMessages, 5000);
}
function stopBot() {
  if(botInterval) {
    clearInterval(botInterval);
    botInterval = null;
  }
}

function updateBotMessages() {
  const forecasts = botForecasts[currentSymbol] || ['Прогнозов нет.'];
  botMessagesUl.innerHTML = '';
  let shuffled = forecasts.slice().sort(() => 0.5 - Math.random());
  let toShow = shuffled.slice(0, 3);
  toShow.forEach(text => {
    const li = document.createElement('li');
    li.textContent = text;
    botMessagesUl.appendChild(li);
  });
}

// Запускаем вспомогательную функцию каждую минуту (пример)
function exampleHelperFunction() {
  console.log(`Helper: текущее время ${new Date().toLocaleTimeString()}`);
}
setInterval(exampleHelperFunction, 60000);
</script>

</body>
</html>
